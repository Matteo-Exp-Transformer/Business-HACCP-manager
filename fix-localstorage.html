<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix LocalStorage - Business HACCP Manager</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .danger {
            background-color: #dc3545;
        }
        .danger:hover {
            background-color: #c82333;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Fix LocalStorage - Business HACCP Manager</h1>
        
        <div id="status" class="status info">
            Pronto per pulire i dati corrotti dal localStorage
        </div>
        
        <div class="log" id="log">
            Clicca "Analizza LocalStorage" per vedere i dati attuali...
        </div>
        
        <div style="text-align: center;">
            <button onclick="analyzeLocalStorage()">üîç Analizza LocalStorage</button>
            <button onclick="fixCorruptedData()" style="background-color: #28a745;">üõ†Ô∏è Fix Dati Corrotti</button>
            <button onclick="clearAllData()" class="danger">üóëÔ∏è Pulisci Tutto</button>
        </div>
        
        <div style="margin-top: 20px;">
            <h3>üìã Cosa fa questo tool:</h3>
            <ul>
                <li><strong>Analizza:</strong> Mostra tutti i dati nel localStorage</li>
                <li><strong>Fix Dati Corrotti:</strong> Rimuove solo i dati che causano errori di parsing</li>
                <li><strong>Pulisci Tutto:</strong> Rimuove tutti i dati (reset completo)</li>
            </ul>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            logElement.textContent += logMessage;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateStatus(message, type) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }

        function analyzeLocalStorage() {
            log('üîç Analizzando localStorage...');
            updateStatus('Analisi in corso...', 'info');
            
            const keys = Object.keys(localStorage);
            log(`Trovate ${keys.length} chiavi nel localStorage:`);
            
            let corruptedCount = 0;
            
            keys.forEach(key => {
                try {
                    const value = localStorage.getItem(key);
                    log(`\nüìÅ ${key}:`);
                    log(`   Tipo: ${typeof value}`);
                    log(`   Lunghezza: ${value ? value.length : 0} caratteri`);
                    
                    // Prova a parsare come JSON
                    if (value && value !== 'undefined' && value !== 'null' && value !== '[object Object]') {
                        try {
                            const parsed = JSON.parse(value);
                            log(`   ‚úÖ JSON valido: ${typeof parsed}`);
                            if (typeof parsed === 'object' && parsed !== null) {
                                log(`   üìä Propriet√†: ${Object.keys(parsed).join(', ')}`);
                            }
                        } catch (e) {
                            log(`   ‚ùå JSON non valido: ${e.message}`);
                            corruptedCount++;
                        }
                    } else {
                        log(`   ‚ö†Ô∏è Valore problematico: ${value}`);
                        corruptedCount++;
                    }
                } catch (e) {
                    log(`   ‚ùå Errore nell'accesso: ${e.message}`);
                    corruptedCount++;
                }
            });
            
            log(`\nüìä Riepilogo:`);
            log(`   Totale chiavi: ${keys.length}`);
            log(`   Dati corrotti: ${corruptedCount}`);
            log(`   Dati validi: ${keys.length - corruptedCount}`);
            
            updateStatus(`Analisi completata: ${corruptedCount} dati corrotti trovati`, corruptedCount > 0 ? 'error' : 'success');
        }

        function fixCorruptedData() {
            log('üõ†Ô∏è Iniziando fix dei dati corrotti...');
            updateStatus('Fix in corso...', 'info');
            
            const keys = Object.keys(localStorage);
            let fixedCount = 0;
            let removedKeys = [];
            
            keys.forEach(key => {
                try {
                    const value = localStorage.getItem(key);
                    
                    // Controlla se il valore √® problematico
                    if (value === 'undefined' || value === 'null' || value === '[object Object]') {
                        localStorage.removeItem(key);
                        removedKeys.push(key);
                        fixedCount++;
                        log(`üóëÔ∏è Rimosso ${key}: valore problematico (${value})`);
                    } else if (value) {
                        // Prova a parsare come JSON
                        try {
                            JSON.parse(value);
                            log(`‚úÖ ${key}: JSON valido`);
                        } catch (e) {
                            localStorage.removeItem(key);
                            removedKeys.push(key);
                            fixedCount++;
                            log(`üóëÔ∏è Rimosso ${key}: JSON non valido (${e.message})`);
                        }
                    }
                } catch (e) {
                    log(`‚ùå Errore nel processare ${key}: ${e.message}`);
                }
            });
            
            log(`\nüìä Fix completato:`);
            log(`   Chiavi rimosse: ${fixedCount}`);
            log(`   Chiavi rimosse: ${removedKeys.join(', ')}`);
            
            updateStatus(`Fix completato: ${fixedCount} dati corrotti rimossi`, 'success');
        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è ATTENZIONE: Questo rimuover√† TUTTI i dati dal localStorage. Sei sicuro?')) {
                log('üóëÔ∏è Pulisco tutto il localStorage...');
                updateStatus('Pulizia in corso...', 'info');
                
                const keys = Object.keys(localStorage);
                localStorage.clear();
                
                log(`\nüìä Pulizia completata:`);
                log(`   Chiavi rimosse: ${keys.length}`);
                log(`   Chiavi rimosse: ${keys.join(', ')}`);
                
                updateStatus('Pulizia completata: tutti i dati rimossi', 'success');
            } else {
                log('‚ùå Pulizia annullata dall\'utente');
                updateStatus('Pulizia annullata', 'info');
            }
        }

        // Analizza automaticamente al caricamento
        window.onload = function() {
            log('üöÄ Tool di fix localStorage caricato');
            log('Clicca "Analizza LocalStorage" per iniziare');
        };
    </script>
</body>
</html>