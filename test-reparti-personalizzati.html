<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Reparti Personalizzati</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .button { 
            background: #007bff; 
            color: white; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 10px; 
        }
        .button:hover { background: #0056b3; }
        .status { margin: 20px 0; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>üß™ Test Reparti Personalizzati HACCP</h1>
    
    <div id="status" class="status info">
        Stato: Inizializzazione...
    </div>
    
    <div class="test-section">
        <h3>Test 1: Simulazione Dati Onboarding</h3>
        <p>Simula i dati dell'onboarding con reparti personalizzati</p>
        <button class="button" onclick="simulateOnboardingData()">Simula Dati Onboarding</button>
        <div id="test1-result"></div>
    </div>
    
    <div class="test-section">
        <h3>Test 2: Verifica Reparti Disponibili</h3>
        <p>Verifica che i reparti personalizzati siano disponibili nello step 2</p>
        <button class="button" onclick="testAvailableDepartments()">Test Reparti Disponibili</button>
        <div id="test2-result"></div>
    </div>
    
    <div class="test-section">
        <h3>Test 3: Apri App e Verifica</h3>
        <p>Apri l'app e verifica che i reparti personalizzati appaiano nello step 2</p>
        <button class="button" onclick="openApp()">Apri App</button>
        <div id="test3-result"></div>
    </div>
    
    <div id="output"></div>

    <script>
        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = `Stato: ${message}`;
            status.className = `status ${type}`;
        }

        function log(message) {
            const output = document.getElementById('output');
            output.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
        }

        function simulateOnboardingData() {
            try {
                // Simula i dati dell'onboarding con reparti personalizzati
                const mockOnboardingData = {
                    currentStep: 1, // Step 2 (Reparti)
                    completedSteps: ['business'],
                    confirmedSteps: [0],
                    formData: {
                        business: {
                            companyName: "Test Pizzeria",
                            address: "Via Test 123",
                            email: "test@pizzeria.com",
                            phone: "1234567890"
                        },
                        departments: {
                            list: [
                                { id: 'cucina', name: 'Cucina', enabled: true, isCustom: false },
                                { id: 'bancone', name: 'Bancone', enabled: true, isCustom: false },
                                { id: 'sala', name: 'Sala', enabled: true, isCustom: false },
                                { id: 'magazzino', name: 'Magazzino', enabled: true, isCustom: false },
                                { id: 'custom-1', name: 'Reparto Personalizzato 1', enabled: true, isCustom: true },
                                { id: 'custom-2', name: 'Reparto Personalizzato 2', enabled: true, isCustom: true }
                            ],
                            enabledCount: 6
                        },
                        staff: {},
                        conservation: {},
                        tasks: {},
                        inventory: {}
                    },
                    lastActivity: new Date().toISOString()
                };
                
                // Salva i dati simulati nel localStorage
                localStorage.setItem('haccp-onboarding-new', JSON.stringify(mockOnboardingData));
                
                document.getElementById('test1-result').innerHTML = `
                    <div class="success">
                        ‚úÖ Dati simulati salvati con successo!<br>
                        Reparti: ${mockOnboardingData.formData.departments.list.length}<br>
                        Reparti personalizzati: ${mockOnboardingData.formData.departments.list.filter(d => d.isCustom).length}
                    </div>
                `;
                
                log('‚úÖ Dati onboarding simulati con reparti personalizzati');
                updateStatus('Dati simulati salvati', 'success');
            } catch (error) {
                document.getElementById('test1-result').innerHTML = `
                    <div class="error">
                        ‚ùå Errore nella simulazione: ${error.message}
                    </div>
                `;
                log(`‚ùå Errore: ${error.message}`);
                updateStatus('Errore nella simulazione', 'error');
            }
        }

        function testAvailableDepartments() {
            try {
                const savedData = localStorage.getItem('haccp-onboarding-new');
                if (!savedData) {
                    document.getElementById('test2-result').innerHTML = `
                        <div class="error">
                            ‚ùå Nessun dato salvato. Esegui prima il Test 1.
                        </div>
                    `;
                    return;
                }
                
                const data = JSON.parse(savedData);
                const departments = data.formData.departments?.list || [];
                const enabledDepartments = departments.filter(dept => dept.enabled);
                const customDepartments = enabledDepartments.filter(dept => dept.isCustom);
                
                // Simula la logica del componente ConservationStep
                const availableDepartments = departments.length > 0 ? 
                    departments.filter(dept => dept.enabled).map(dept => dept.name || dept) : 
                    ['Cucina', 'Bancone', 'Sala', 'Magazzino'];
                
                document.getElementById('test2-result').innerHTML = `
                    <div class="success">
                        ‚úÖ Test completato!<br>
                        <strong>Reparti totali:</strong> ${departments.length}<br>
                        <strong>Reparti attivi:</strong> ${enabledDepartments.length}<br>
                        <strong>Reparti personalizzati:</strong> ${customDepartments.length}<br>
                        <strong>Reparti disponibili per step 2:</strong> ${availableDepartments.join(', ')}
                    </div>
                `;
                
                log(`‚úÖ Reparti disponibili: ${availableDepartments.join(', ')}`);
                updateStatus('Test reparti completato', 'success');
            } catch (error) {
                document.getElementById('test2-result').innerHTML = `
                    <div class="error">
                        ‚ùå Errore nel test: ${error.message}
                    </div>
                `;
                log(`‚ùå Errore: ${error.message}`);
                updateStatus('Errore nel test', 'error');
            }
        }

        function openApp() {
            try {
                // Apri l'app in una nuova finestra
                const appUrl = 'http://localhost:3000';
                window.open(appUrl, '_blank');
                
                document.getElementById('test3-result').innerHTML = `
                    <div class="info">
                        üöÄ App aperta in nuova finestra<br>
                        <strong>Istruzioni:</strong><br>
                        1. Vai allo step 2 (Reparti)<br>
                        2. Aggiungi 2 reparti personalizzati<br>
                        3. Vai allo step 3 (Punti di Conservazione)<br>
                        4. Verifica che i reparti personalizzati appaiano nel dropdown "Luogo"
                    </div>
                `;
                
                updateStatus('App aperta in nuova finestra', 'success');
                log(`üöÄ App aperta: ${appUrl}`);
            } catch (error) {
                document.getElementById('test3-result').innerHTML = `
                    <div class="error">
                        ‚ùå Errore nell'apertura app: ${error.message}
                    </div>
                `;
                log(`‚ùå Errore: ${error.message}`);
                updateStatus('Errore nell\'apertura app', 'error');
            }
        }

        // Inizializzazione
        window.onload = function() {
            updateStatus('Pronto per il test', 'success');
            log('‚úÖ Pagina di test caricata');
            
            // Controlla se l'app √® in esecuzione
            fetch('http://localhost:3000')
                .then(() => {
                    log('‚úÖ App in esecuzione su localhost:3000');
                })
                .catch(() => {
                    log('‚ö†Ô∏è App non in esecuzione su localhost:3000');
                    updateStatus('Avvia prima l\'app con npm run dev', 'error');
                });
        };
    </script>
</body>
</html>
