<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Fix - HACCP Manager</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .fix-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { color: #22c55e; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
        .info { color: #3b82f6; }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 16px;
        }
        button:hover { background: #2563eb; }
        button.danger {
            background: #ef4444;
        }
        button.danger:hover {
            background: #dc2626;
        }
        button.success {
            background: #22c55e;
        }
        button.success:hover {
            background: #16a34a;
        }
        .status {
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success { background: #f0fdf4; border: 2px solid #22c55e; }
        .status.error { background: #fef2f2; border: 2px solid #ef4444; }
        .status.warning { background: #fffbeb; border: 2px solid #f59e0b; }
        .status.info { background: #eff6ff; border: 2px solid #3b82f6; }
    </style>
</head>
<body>
    <h1>üöÄ Quick Fix - HACCP Manager</h1>
    
    <div class="fix-section">
        <h2>‚ö° Fix Rapido per LocalStorage</h2>
        <p>Questo strumento risolve rapidamente i problemi di parsing JSON e permette di testare l'app.</p>
        
        <div id="status-container">
            <div id="status" class="status info">Pronto per il fix...</div>
        </div>
        
        <div id="actions">
            <button onclick="quickFix()" class="success">üöÄ Quick Fix Completo</button>
            <button onclick="clearStorage()" class="danger">üóëÔ∏è Pulisci Tutto</button>
            <button onclick="testApp()" class="info">üß™ Testa App</button>
        </div>
        
        <div id="results">
            <h3>Risultati:</h3>
            <div id="results-list"></div>
        </div>
    </div>

    <script>
        function addResult(type, message) {
            const resultsContainer = document.getElementById('results-list');
            const resultDiv = document.createElement('div');
            resultDiv.className = `status ${type}`;
            resultDiv.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            resultsContainer.appendChild(resultDiv);
            
            // Mantieni solo gli ultimi 10 risultati
            while (resultsContainer.children.length > 10) {
                resultsContainer.removeChild(resultsContainer.firstChild);
            }
        }

        function updateStatus(type, message) {
            const statusEl = document.getElementById('status');
            statusEl.className = `status ${type}`;
            statusEl.innerHTML = message;
        }

        function quickFix() {
            updateStatus('warning', 'üõ†Ô∏è Applicando fix rapido...');
            addResult('info', 'üöÄ Iniziando fix rapido...');
            
            try {
                // 1. Pulisci tutto il localStorage
                localStorage.clear();
                addResult('success', '‚úÖ LocalStorage completamente pulito');
                
                // 2. Imposta valori di default puliti
                const defaultOnboarding = {
                    completed: false,
                    currentStep: 0,
                    confirmedSteps: []
                };
                
                const defaultDevMode = {
                    enabled: false,
                    features: [],
                    bypassOnboarding: false,
                    showDebugInfo: false,
                    lastToggled: null,
                    reason: null
                };
                
                localStorage.setItem('haccp-onboarding', JSON.stringify(defaultOnboarding));
                localStorage.setItem('haccp-dev-mode', JSON.stringify(defaultDevMode));
                
                addResult('success', '‚úÖ Valori di default impostati');
                addResult('success', '‚úÖ Fix completato con successo!');
                
                updateStatus('success', '‚úÖ Fix Completato! Ora puoi testare l\'app.');
                
                // 3. Verifica che tutto sia pulito
                setTimeout(() => {
                    verifyFix();
                }, 500);
                
            } catch (error) {
                addResult('error', `‚ùå Errore durante il fix: ${error.message}`);
                updateStatus('error', '‚ùå Errore durante il fix');
            }
        }

        function clearStorage() {
            if (confirm('‚ö†Ô∏è ATTENZIONE: Questo rimuover√† TUTTI i dati dal localStorage. Sei sicuro?')) {
                updateStatus('warning', 'üóëÔ∏è Pulendo localStorage...');
                localStorage.clear();
                addResult('success', '‚úÖ LocalStorage completamente pulito');
                updateStatus('success', '‚úÖ LocalStorage pulito');
            }
        }

        function verifyFix() {
            addResult('info', 'üîç Verificando fix...');
            
            try {
                // Verifica onboarding
                const onboarding = localStorage.getItem('haccp-onboarding');
                if (onboarding) {
                    const parsed = JSON.parse(onboarding);
                    if (parsed && parsed.completed === false) {
                        addResult('success', '‚úÖ Onboarding configurato correttamente');
                    } else {
                        addResult('error', '‚ùå Problema con onboarding');
                    }
                }
                
                // Verifica dev mode
                const devMode = localStorage.getItem('haccp-dev-mode');
                if (devMode) {
                    const parsed = JSON.parse(devMode);
                    if (parsed && parsed.enabled === false) {
                        addResult('success', '‚úÖ Dev mode configurato correttamente');
                    } else {
                        addResult('error', '‚ùå Problema con dev mode');
                    }
                }
                
                addResult('success', '‚úÖ Verifica completata - App pronta per il test!');
                
            } catch (error) {
                addResult('error', `‚ùå Errore durante la verifica: ${error.message}`);
            }
        }

        function testApp() {
            addResult('info', 'üß™ Testando app...');
            
            // Verifica che l'app sia accessibile
            try {
                // Simula un test di accesso all'app
                const testData = {
                    onboarding: localStorage.getItem('haccp-onboarding'),
                    devMode: localStorage.getItem('haccp-dev-mode'),
                    totalKeys: localStorage.length
                };
                
                addResult('info', `üìä Stato localStorage: ${testData.totalKeys} chiavi`);
                
                if (testData.onboarding && testData.devMode) {
                    addResult('success', '‚úÖ App pronta per il test!');
                    addResult('info', 'üîÑ Ora ricarica l\'app HACCP Manager e testa l\'onboarding');
                } else {
                    addResult('warning', '‚ö†Ô∏è App non completamente configurata');
                }
                
            } catch (error) {
                addResult('error', `‚ùå Errore durante il test: ${error.message}`);
            }
        }

        // Inizializzazione
        window.addEventListener('load', () => {
            updateStatus('info', 'üöÄ Pronto per il fix rapido');
            addResult('info', 'üöÄ Quick Fix Tool caricato');
            
            // Verifica stato iniziale
            if (localStorage.length > 0) {
                addResult('warning', `‚ö†Ô∏è Trovate ${localStorage.length} chiavi nel localStorage`);
            } else {
                addResult('success', '‚úÖ LocalStorage gi√† pulito');
            }
        });
    </script>
</body>
</html>
